<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ToastCaseScenario - KI-Feedback f√ºr Zivilrechtsklausuren</title>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700&family=Crimson+Text:ital,wght@0,400;0,600;1,400&display=swap" rel="stylesheet">
    <style>
        :root {
            --parchment-base: rgb(243, 206, 109);
            --parchment-light: rgba(243, 206, 109, 0.1);
            --parchment-medium: rgba(243, 206, 109, 0.3);
            --parchment-dark: rgba(203, 166, 69, 1);
            --highlight: rgb(232, 103, 137);
            --highlight-light: rgba(232, 103, 137, 0.1);
            --highlight-medium: rgba(232, 103, 137, 0.3);
            --text-dark: #2c1810;
            --text-medium: #5c402c;
            --text-light: #8b6f4d;
            --shadow-warm: rgba(203, 166, 69, 0.2);
            --shadow-soft: rgba(44, 24, 16, 0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Crimson Text', serif;
            background: linear-gradient(135deg, var(--parchment-light) 0%, rgba(252, 236, 176, 0.3) 50%, var(--parchment-medium) 100%);
            color: var(--text-dark);
            line-height: 1.6;
            min-height: 100vh;
            position: relative;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-image:
                radial-gradient(circle at 20% 20%, var(--parchment-light) 0%, transparent 50%),
                radial-gradient(circle at 80% 80%, var(--highlight-light) 0%, transparent 50%),
                radial-gradient(circle at 40% 60%, rgba(255, 248, 220, 0.3) 0%, transparent 50%);
            pointer-events: none;
            z-index: -1;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 40px 20px;
            position: relative;
            z-index: 1;
        }

        .header {
            text-align: center;
            margin-bottom: 60px;
            position: relative;
        }

        .header::after {
            content: '';
            position: absolute;
            bottom: -20px;
            left: 50%;
            transform: translateX(-50%);
            width: 100px;
            height: 2px;
            background: linear-gradient(90deg, transparent 0%, var(--highlight) 50%, transparent 100%);
        }

        .header h1 {
            font-family: 'Playfair Display', serif;
            font-size: clamp(2.5rem, 5vw, 3.5rem);
            font-weight: 700;
            color: var(--text-dark);
            margin-bottom: 15px;
            text-shadow: 2px 2px 4px var(--shadow-soft);
            letter-spacing: -0.02em;
        }

        .header p {
            color: var(--text-medium);
            font-size: 1.2rem;
            font-style: italic;
            font-weight: 400;
        }

        .card {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            box-shadow:
                0 20px 40px var(--shadow-soft),
                inset 0 1px 0 rgba(255, 255, 255, 0.6);
            padding: 40px;
            margin-bottom: 30px;
            position: relative;
            overflow: hidden;
            border: 1px solid rgba(243, 206, 109, 0.2);
        }

        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--parchment-base) 0%, var(--highlight) 50%, var(--parchment-base) 100%);
        }

        .card h2 {
            font-family: 'Playfair Display', serif;
            margin-bottom: 25px;
            color: var(--text-dark);
            font-size: 1.8rem;
            font-weight: 600;
            position: relative;
            padding-left: 20px;
        }

        .card h2::before {
            content: '‚ú¶';
            position: absolute;
            left: -5px;
            top: 0;
            color: var(--highlight);
            font-size: 1.2rem;
        }

        .form-group {
            margin-bottom: 30px;
        }

        .form-group label {
            display: block;
            margin-bottom: 12px;
            font-weight: 600;
            color: var(--text-dark);
            font-size: 1.1rem;
        }

        select, textarea, input[type="file"] {
            width: 100%;
            padding: 18px 20px;
            border: 2px solid var(--parchment-medium);
            border-radius: 15px;
            font-size: 16px;
            font-family: 'Crimson Text', serif;
            background: rgba(255, 255, 255, 0.9);
            color: var(--text-dark);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        select:focus, textarea:focus, input[type="file"]:focus {
            outline: none;
            border-color: var(--highlight);
            box-shadow:
                0 0 0 4px var(--highlight-light),
                0 8px 25px var(--shadow-soft);
            transform: translateY(-2px);
        }

        select {
            cursor: pointer;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3E%3Cpath stroke='%23e86789' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M6 8l4 4 4-4'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 15px center;
            background-size: 16px;
            appearance: none;
        }

        textarea {
            resize: vertical;
            min-height: 180px;
            line-height: 1.6;
        }

        .counter {
            text-align: right;
            margin-top: 8px;
            font-size: 14px;
            color: var(--text-light);
            font-style: italic;
        }

        .button-group {
            display: flex;
            gap: 15px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 15px 30px;
            border: none;
            border-radius: 50px;
            font-size: 16px;
            font-weight: 600;
            font-family: 'Crimson Text', serif;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: inline-flex;
            align-items: center;
            gap: 10px;
            position: relative;
            overflow: hidden;
            text-decoration: none;
            white-space: nowrap;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            transition: left 0.5s;
        }

        .btn:hover::before {
            left: 100%;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--highlight) 0%, #c8487a 100%);
            color: white;
            box-shadow: 0 8px 25px rgba(232, 103, 137, 0.3);
        }

        .btn-primary:hover:not(:disabled) {
            background: linear-gradient(135deg, #c8487a 0%, var(--highlight) 100%);
            transform: translateY(-3px);
            box-shadow: 0 15px 35px rgba(232, 103, 137, 0.4);
        }

        .btn-secondary {
            background: rgba(243, 206, 109, 0.2);
            color: var(--text-dark);
            border: 2px solid var(--parchment-base);
            backdrop-filter: blur(10px);
        }

        .btn-secondary:hover:not(:disabled) {
            background: var(--parchment-base);
            transform: translateY(-2px);
            box-shadow: 0 10px 25px var(--shadow-warm);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
        }

        .facts-box {
            background: linear-gradient(135deg, var(--parchment-light) 0%, rgba(255, 248, 220, 0.5) 100%);
            padding: 25px;
            border-radius: 15px;
            margin-top: 15px;
            font-size: 15px;
            line-height: 1.7;
            border: 1px solid var(--parchment-medium);
            position: relative;
        }

        .facts-box::before {
            content: 'üìú';
            position: absolute;
            top: 15px;
            right: 20px;
            font-size: 20px;
            opacity: 0.7;
        }

        .spinner {
            width: 24px;
            height: 24px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-top: 3px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .result-card {
            display: none;
            border-left: 6px solid var(--highlight);
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.95) 0%, rgba(243, 206, 109, 0.1) 100%);
        }

        .score-section {
            margin-bottom: 30px;
            text-align: center;
        }

        .total-score {
            font-family: 'Playfair Display', serif;
            font-size: 3.5rem;
            font-weight: 700;
            color: var(--highlight);
            text-align: center;
            margin-bottom: 20px;
            text-shadow: 2px 2px 4px var(--shadow-soft);
        }

        .progress-bar {
            width: 100%;
            height: 12px;
            background: rgba(203, 166, 69, 0.2);
            border-radius: 20px;
            margin-bottom: 25px;
            overflow: hidden;
            position: relative;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--parchment-base) 0%, var(--highlight) 100%);
            border-radius: 20px;
            transition: width 0.8s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
        }

        .progress-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, transparent 0%, rgba(255, 255, 255, 0.3) 50%, transparent 100%);
            animation: shimmer 2s infinite;
        }

        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        .subscores {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .subscore-item {
            text-align: center;
            padding: 20px;
            background: rgba(255, 255, 255, 0.7);
            border-radius: 15px;
            border: 1px solid var(--parchment-medium);
            transition: transform 0.3s ease;
        }

        .subscore-item:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px var(--shadow-soft);
        }

        .subscore-value {
            font-family: 'Playfair Display', serif;
            font-size: 2rem;
            font-weight: 600;
            color: var(--highlight);
            margin-bottom: 5px;
        }

        .subscore-label {
            font-size: 14px;
            color: var(--text-medium);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .feedback-section {
            display: grid;
            grid-template-columns: 1fr;
            gap: 25px;
        }

        @media (min-width: 768px) {
            .feedback-section {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        .feedback-item {
            padding: 25px;
            border-radius: 15px;
            position: relative;
        }

        .feedback-item:nth-child(1) {
            background: linear-gradient(135deg, rgba(76, 175, 80, 0.1) 0%, rgba(129, 199, 132, 0.1) 100%);
            border: 1px solid rgba(76, 175, 80, 0.2);
        }

        .feedback-item:nth-child(2) {
            background: linear-gradient(135deg, rgba(244, 67, 54, 0.1) 0%, rgba(229, 115, 115, 0.1) 100%);
            border: 1px solid rgba(244, 67, 54, 0.2);
        }

        .feedback-item:nth-child(3) {
            background: linear-gradient(135deg, var(--highlight-light) 0%, rgba(232, 103, 137, 0.05) 100%);
            border: 1px solid var(--highlight-medium);
        }

        .feedback-item h4 {
            margin-bottom: 12px;
            font-family: 'Playfair Display', serif;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .toast-container {
            position: fixed;
            top: 30px;
            right: 30px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .toast {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            box-shadow: 0 10px 30px var(--shadow-soft);
            padding: 20px;
            max-width: 350px;
            display: flex;
            align-items: flex-start;
            gap: 12px;
            animation: slideIn 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            border: 1px solid var(--parchment-medium);
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%) scale(0.8);
                opacity: 0;
            }
            to {
                transform: translateX(0) scale(1);
                opacity: 1;
            }
        }

        .toast-success { border-left: 4px solid #4caf50; }
        .toast-error { border-left: 4px solid #f44336; }
        .toast-info { border-left: 4px solid var(--highlight); }

        .toast-icon {
            font-size: 20px;
            flex-shrink: 0;
        }

        .toast-content {
            flex: 1;
            font-size: 15px;
        }

        .toast-close {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: var(--text-light);
            padding: 0;
            transition: color 0.2s;
        }

        .toast-close:hover {
            color: var(--text-dark);
        }

        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(44, 24, 16, 0.7);
            backdrop-filter: blur(5px);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1001;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .overlay-content {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 40px;
            border-radius: 25px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 25px 50px rgba(44, 24, 16, 0.3);
            border: 1px solid var(--parchment-medium);
            animation: scaleIn 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        @keyframes scaleIn {
            from {
                transform: scale(0.8);
                opacity: 0;
            }
            to {
                transform: scale(1);
                opacity: 1;
            }
        }

        .feedback-form {
            display: flex;
            flex-direction: column;
            gap: 25px;
        }

        .rating-group {
            display: flex;
            gap: 12px;
            align-items: center;
            flex-wrap: wrap;
        }

        .rating-btn {
            width: 50px;
            height: 50px;
            border: 2px solid var(--parchment-medium);
            background: rgba(255, 255, 255, 0.8);
            border-radius: 15px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-family: 'Crimson Text', serif;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            color: var(--text-dark);
        }

        .rating-btn:hover {
            border-color: var(--highlight);
            transform: translateY(-2px);
            box-shadow: 0 8px 20px var(--shadow-soft);
        }

        .rating-btn.active {
            background: var(--highlight);
            color: white;
            border-color: var(--highlight);
            transform: translateY(-2px);
        }

        .footer {
            margin-top: 60px;
            padding-top: 30px;
            border-top: 2px solid var(--parchment-medium);
            text-align: center;
            font-size: 14px;
            color: var(--text-light);
        }

        .footer a {
            color: var(--highlight);
            text-decoration: none;
            font-weight: 600;
            transition: color 0.2s;
        }

        .footer a:hover {
            color: var(--text-dark);
            text-decoration: underline;
        }

        .privacy-notice {
            background: linear-gradient(135deg, var(--highlight-light) 0%, rgba(232, 103, 137, 0.05) 100%);
            border: 1px solid var(--highlight-medium);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 25px;
            font-size: 14px;
            color: var(--text-dark);
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .container {
                padding: 20px 15px;
            }

            .card {
                padding: 25px 20px;
            }

            .button-group {
                flex-direction: column;
            }

            .subscores {
                grid-template-columns: repeat(2, 1fr);
            }

            .feedback-section {
                grid-template-columns: 1fr;
            }

            .toast-container {
                right: 15px;
                left: 15px;
            }

            .toast {
                max-width: none;
            }
        }

        @media print {
            body * {
                visibility: hidden;
            }
            .result-card, .result-card * {
                visibility: visible;
            }
            .result-card {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üå≠‚öñÔ∏èWurstCaseScenario</h1>
            <p>KI-Feedback f√ºr Zivilrechtsklausuren</p>
        </div>

        <div class="card">
            <h2>Fall ausw√§hlen</h2>
            <div class="form-group">
                <label for="caseSelect">W√§hle einen Fall:</label>
                <select id="caseSelect">
                    <option value="">-- Bitte w√§hlen --</option>
                    <option value="A">Fall A: Ein hei√üer Hund</option>
                    <option value="B">Fall B: Ein teurer Tropfen</option>
                </select>
                <div id="factsBox" class="facts-box" style="display: none;">
                    <img id="caseImage" src="" alt="Fall-Bild"
                         style="max-width:100%; margin-bottom:15px; border-radius:10px; display:none;">
                    <div id="factsText"></div>
                </div>
            </div>
        </div>

        <div class="card">
            <h2>Deine L√∂sung</h2>
            <div class="form-group">
                <label for="solutionText">L√∂sung eingeben oder Datei hochladen:</label>
                <textarea id="solutionText" placeholder="Gib hier deine Falll√∂sung ein..."></textarea>
                <div class="counter" id="textCounter">0 W√∂rter, 0 Zeichen</div>
                <div class="button-group">
                    <input type="file" id="fileInput" accept=".txt" style="display: none;">
                    <button type="button" class="btn btn-secondary" onclick="document.getElementById('fileInput').click();">üìÑ .txt importieren</button>
                    <button type="button" class="btn btn-secondary" onclick="resetSolution()">üóëÔ∏è Zur√ºcksetzen</button>
                </div>
            </div>
        </div>

        <div class="card">
            <h2>Auswertung</h2>
            <button id="evaluateBtn" class="btn btn-primary" onclick="evaluateSolution()">
                <span id="evaluateText">üìä Bewerten</span>
                <div id="evaluateSpinner" class="spinner" style="display: none;"></div>
            </button>
        </div>

        <div id="resultCard" class="card result-card">
            <h2>Bewertungsergebnis</h2>
            <div class="score-section">
                <div id="totalScore" class="total-score">0 / 40</div>
                <div class="progress-bar"><div id="progressFill" class="progress-fill" style="width: 0%;"></div></div>
                <div id="subscores" class="subscores"></div>
            </div>
            <div id="feedbackSection" class="feedback-section"></div>
            <div class="button-group" style="margin-top: 30px;">
                <button type="button" class="btn btn-secondary" onclick="window.print()">üñ®Ô∏è PDF speichern</button>
                <button type="button" class="btn btn-primary" onclick="openFeedbackOverlay()">üí¨ Feedback geben</button>
            </div>
        </div>
    </div>

    <div id="feedbackOverlay" class="overlay">
        <div class="overlay-content">
            <h2 style="font-family: 'Playfair Display', serif; margin-bottom: 25px; color: var(--text-dark);">Feedback zur Bewertung</h2>
            <div class="privacy-notice">
                <strong>Datenschutz:</strong> Dein Feedback wird anonym an unseren Make-Webhook gesendet und dort an Telegram/Spreadsheet weitergeleitet. Keine personenbezogenen Daten werden gespeichert.
            </div>
            <form class="feedback-form" onsubmit="submitFeedback(event)">
                <div class="form-group">
                    <label>War das Feedback hilfreich?</label>
                    <div class="rating-group">
                        <button type="button" class="rating-btn" data-helpful="true" onclick="selectHelpful(true)">Ja</button>
                        <button type="button" class="rating-btn" data-helpful="false" onclick="selectHelpful(false)">Nein</button>
                    </div>
                </div>
                <div class="form-group">
                    <label>Wie wahrscheinlich w√ºrdest du WurstCaseScenario weiterempfehlen? (1-5)</label>
                    <div class="rating-group">
                        <button type="button" class="rating-btn" data-likelihood="1" onclick="selectLikelihood(1)">1</button>
                        <button type="button" class="rating-btn" data-likelihood="2" onclick="selectLikelihood(2)">2</button>
                        <button type="button" class="rating-btn" data-likelihood="3" onclick="selectLikelihood(3)">3</button>
                        <button type="button" class="rating-btn" data-likelihood="4" onclick="selectLikelihood(4)">4</button>
                        <button type="button" class="rating-btn" data-likelihood="5" onclick="selectLikelihood(5)">5</button>
                    </div>
                </div>
                <div class="form-group">
                    <label for="feedbackComment">Zus√§tzliche Anmerkungen (optional):</label>
                    <textarea id="feedbackComment" placeholder="Was k√∂nnen wir verbessern?" rows="3"></textarea>
                </div>
                <div class="button-group">
                    <button type="button" class="btn btn-secondary" onclick="closeFeedbackOverlay()">Abbrechen</button>
                    <button type="submit" class="btn btn-primary">
                        <span id="feedbackSubmitText">Feedback senden</span>
                        <div id="feedbackSpinner" class="spinner" style="display: none;"></div>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <div class="footer">
        <p>
            <a href="mailto:info@wurstcasescenario.de">Kontakt</a> |
            <a href="#" onclick="alert('Impressum: Wurst, Beispielstra√üe 123, 12345 Musterstadt')">Impressum</a> |
            <a href="#" onclick="alert('Datenschutz: Nur anonyme Daten werden verarbeitet.')">Datenschutz</a>
        </p>
        <p style="margin-top: 15px;"><strong>Wichtiger Hinweis:</strong> Diese Anwendung dient nur zu √úbungszwecken und stellt keine Rechtsberatung dar.</p>
    </div>

    <div id="toastContainer" class="toast-container"></div>

    <script>
        // === Webhook-Konstanten ===
        const MAKE_OPENAI_WEBHOOK_URL = "https://hook.eu2.make.com/aqq1vmqcauxbq83gi78whtcyacqp0mrb";
        const MAKE_FEEDBACK_WEBHOOK_URL = "https://hook.eu2.make.com/e2o3ee1057r6cdihtaihph5o9bwgfejt";

        // Cases Data
        const cases = {
            A: {
                title: "Ein hei√üer Hund",
                facts: "Die elfj√§hrige Marie (M), die √§lter aussieht als sie ist, ist des t√§glichen Spazierengehens mit dem Familienhund Henry √ºberdr√ºssig. Daher sagt M kurzentschlossen und eigenm√§chtig zu der ihr unbekannten Passantin Patricia (P):\n" +
                  "\n" +
                  "‚ÄûF√ºr 300 ‚Ç¨ geh√∂rt Henry Dir.‚Äú\n" +
                  "\n" +
                  "P antwortet:\n" +
                  "\n" +
                  "‚ÄûGerne. Ich habe aber nur 200 ‚Ç¨ dabei; den Rest gebe ich Dir in einer Woche.‚Äù\n" +
                  "\n" +
                  "M ist einverstanden, √ºbergibt den Hund an P und nimmt von dieser einen 200-Euro-Schein entgegen. Sp√§ter am Tag wird P klar, dass ein Vertrag mit M aufgrund deren Alters rechtlich problematisch sein k√∂nnte. Daher sucht sie die Eltern der M auf und bittet sie um deren ‚ÄûOK‚Äú. Die Eltern √§u√üern sich nicht. Gleich am n√§chsten Tag ist P so genervt von dem st√§ndigen Bellen des Henry, dass sie gegen√ºber M erkl√§rt, dass ‚Äûsie sich hiermit nun doch vom Vertrag zur√ºckziehe und M den Hund wieder haben k√∂nne; au√üerdem k√∂nne sie den Kauf nicht gelten lassen, weil sie M f√ºr √§lter gehalten habe‚Äú.\n" +
                  "\n" +
                  "Fallfrage: \n" +
                  "Kann M von P die Zahlung von weiteren 100 ‚Ç¨ verlangen?\n",
                idealSolution: "",
                image:"img/Fall_A.png",
                pointsSchema: { structure: 10, subsumption: 10, norms: 10, argumentation: 10 }
            },
            B: {
                title: "Ein teurer Tropfen",
                facts: "Ms Eltern feiern mit Freunden im Restaurant des Raffaello (R). Um geb√ºhrend ansto√üen zu k√∂nnen, m√∂chte der Vater Valentin (V) einen ‚Äûedlen Tropfen Champagner‚Äú bestellen. Der bei R angestellte Kellner Kurt (K) zeigt V daraufhin eine Flasche und nennt einen Preis i.H.v. 1.300 ‚Ç¨ (objektiver Wert der Flasche: 1.000 ‚Ç¨). Obwohl K einen ruhigen Moment abwartet und, an die Lautst√§rke angepasst, mit erhobener Stimme spricht, versteht V einen Preis von 300 ‚Ç¨, da er von der Partylaune seiner Freunde abgelenkt ist. Begeistert nimmt V dem K die Flasche aus der Hand und √∂ffnet sie fachm√§nnisch mit einem S√§bel. Kurz darauf stellt sich heraus, dass K eine veraltete Preisliste herangezogen hatte. K teilt V sogleich mit, dass der zun√§chst mitgeteilte Preis von 1.300 ‚Ç¨ falsch sei und daher nicht gelte. Tats√§chlich liege der Preis bei 2.000 ‚Ç¨. Daraufhin weigert sich V, angesichts des von ihm Geh√∂rten mehr als 300 ‚Ç¨ zu zahlen; irgendeinen h√∂heren Preis werde er keinesfalls entrichten.\n" +
                                "\n" +
                                "Fallfrage:\n" +
                                "Kann R von V die Bezahlung der Flasche Champagner verlangen, und wenn ja, in welcher H√∂he?\n",
                idealSolution: "",
                image: "img/Fall_B.png",
                pointsSchema: { structure: 10, subsumption: 10, norms: 10, argumentation: 10 }
            }
        };

        // Global variables
        let lastEvaluation = null;
        let feedbackData = null;

        // Toast System
        let toastCount = 0;
        const maxToasts = 3;
        function toast(message, type = 'info') {
            const container = document.getElementById('toastContainer');
            const toasts = container.children;
            if (toasts.length >= maxToasts) { container.removeChild(toasts[0]); toastCount--; }
            const toastEl = document.createElement('div');
            toastEl.className = `toast toast-${type}`;
            const icons = { success: '‚úÖ', error: '‚ùå', info: '‚ÑπÔ∏è' };
            toastEl.innerHTML = `
                <span class="toast-icon">${icons[type]}</span>
                <div class="toast-content">${message}</div>
                <button class="toast-close" onclick="this.parentElement.remove(); toastCount--;">√ó</button>`;
            container.appendChild(toastEl); toastCount++;
            setTimeout(()=>{ if (toastEl.parentElement) { toastEl.remove(); toastCount--; } }, 5000);
        }

        // Rate limiting
        function canEvaluate() {
            const lastEval = localStorage.getItem('lastEvaluation');
            if (!lastEval) return true;
            const timeDiff = Date.now() - parseInt(lastEval);
            return timeDiff >= 60000; // 1 minute
        }

        // Case selection
        document.getElementById('caseSelect').addEventListener('change', function() {
            const selectedCase = this.value;
            const factsBox = document.getElementById('factsBox');
            const factsText = document.getElementById('factsText');
            const caseImage = document.getElementById('caseImage');

            if (selectedCase && cases[selectedCase]) {
                factsText.textContent = cases[selectedCase].facts;
                caseImage.src = cases[selectedCase].image;
                caseImage.style.display = 'block';
                factsBox.style.display = 'block';
            } else {
                factsBox.style.display = 'none';
                caseImage.style.display = 'none';
            }
        });

        // Text counter
        document.getElementById('solutionText').addEventListener('input', function() {
            const text = this.value;
            const words = text.trim() ? text.trim().split(/\s+/).length : 0;
            const chars = text.length;
            document.getElementById('textCounter').textContent = `${words} W√∂rter, ${chars} Zeichen`;
        });

        // File upload
        document.getElementById('fileInput').addEventListener('change', function() {
            const file = this.files[0]; if (!file) return;
            if (!file.name.endsWith('.txt')) { toast('Bitte w√§hle eine .txt Datei aus.', 'error'); return; }
            const reader = new FileReader();
            reader.onload = e => {
                document.getElementById('solutionText').value = e.target.result;
                document.getElementById('solutionText').dispatchEvent(new Event('input'));
                toast('Datei erfolgreich geladen!', 'success');
            };
            reader.readAsText(file);
        });

        function resetSolution() {
            document.getElementById('solutionText').value = '';
            document.getElementById('solutionText').dispatchEvent(new Event('input'));
            document.getElementById('fileInput').value = '';
            toast('L√∂sung zur√ºckgesetzt.', 'info');
        }

        async function evaluateSolution() {
            const caseId = document.getElementById('caseSelect').value;
            const solutionText = document.getElementById('solutionText').value.trim();

            if (!caseId) { toast('Bitte w√§hle einen Fall aus.', 'error'); return; }
            if (!solutionText) { toast('Bitte gib eine L√∂sung ein.', 'error'); return; }
            if (solutionText.length < 50) { toast('Die L√∂sung sollte mindestens 50 Zeichen lang sein.', 'error'); return; }
            if (!canEvaluate()) { toast('Bitte warte eine Minute zwischen den Bewertungen.', 'error'); return; }

            const btn = document.getElementById('evaluateBtn');
            const text = document.getElementById('evaluateText');
            const spinner = document.getElementById('evaluateSpinner');
            btn.disabled = true; text.textContent = 'Wird bewertet...'; spinner.style.display = 'block';

            try {
                const response = await fetch(MAKE_OPENAI_WEBHOOK_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        type: 'openai',
                        caseId,
                        solutionText,
                        idealSolution: cases[caseId].idealSolution,
                        pointsSchema: cases[caseId].pointsSchema
                    })
                });
                if (!response.ok) throw new Error(`HTTP ${response.status}`);

                const result = await response.json();
                localStorage.setItem('lastEvaluation', Date.now().toString());
                lastEvaluation = result;
                displayResult(result, caseId);
                toast('Bewertung erfolgreich abgeschlossen!', 'success');
                setTimeout(openFeedbackOverlay, 2000);
            } catch (error) {
                console.error('Evaluation error:', error);
                toast('Fehler bei der Bewertung. Bitte versuche es sp√§ter erneut.', 'error');
            } finally {
                btn.disabled = false; text.textContent = 'üìä Bewerten'; spinner.style.display = 'none';
            }
        }

        function displayResult(result, caseId) {
            const resultCard = document.getElementById('resultCard');
            const totalScore = document.getElementById('totalScore');
            const progressFill = document.getElementById('progressFill');
            const subscores = document.getElementById('subscores');
            const feedbackSection = document.getElementById('feedbackSection');

            const maxScore = Object.values(cases[caseId].pointsSchema).reduce((a,b)=>a+b,0);
            const percentage = (result.totalScore / maxScore) * 100;

            totalScore.textContent = `${result.totalScore} / ${maxScore}`;
            progressFill.style.width = `${percentage}%`;

            subscores.innerHTML = '';
            for (const [category, score] of Object.entries(result.subscores)) {
                const maxCategoryScore = cases[caseId].pointsSchema[category];
                subscores.innerHTML += `
                    <div class="subscore-item">
                        <div class="subscore-value">${score}/${maxCategoryScore}</div>
                        <div class="subscore-label">${category}</div>
                    </div>`;
            }

            feedbackSection.innerHTML = `
                <div class="feedback-item">
                    <h4>üü¢ St√§rken</h4>
                    <p>${result.summary.strengths}</p>
                </div>
                <div class="feedback-item weaknesses">
                    <h4>üî¥ Schw√§chen</h4>
                    <p>${result.summary.weaknesses}</p>
                </div>
                <div class="feedback-item tip">
                    <h4>üí° Tipp</h4>
                    <p>${result.summary.tip}</p>
                </div>`;
            resultCard.style.display = 'block';
            resultCard.scrollIntoView({ behavior: 'smooth' });
        }

        // Feedback overlay functions
        function openFeedbackOverlay() {
            if (!lastEvaluation) { toast('Erst eine Bewertung durchf√ºhren!', 'error'); return; }
            document.getElementById('feedbackOverlay').style.display = 'flex';
        }
        function closeFeedbackOverlay() { document.getElementById('feedbackOverlay').style.display = 'none'; resetFeedbackForm(); }
        function resetFeedbackForm() {
            document.querySelectorAll('.rating-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById('feedbackComment').value = '';
            feedbackData = null;
        }
        function selectHelpful(helpful) {
            document.querySelectorAll('[data-helpful]').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`[data-helpful="${helpful}"]`).classList.add('active');
            if (!feedbackData) feedbackData = {}; feedbackData.helpful = helpful;
        }
        function selectLikelihood(likelihood) {
            document.querySelectorAll('[data-likelihood]').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`[data-likelihood="${likelihood}"]`).classList.add('active');
            if (!feedbackData) feedbackData = {}; feedbackData.likelihood = likelihood;
        }

        async function submitFeedback(event) {
            event.preventDefault();
            if (!feedbackData || feedbackData.helpful === undefined || !feedbackData.likelihood) {
                toast('Bitte beantworte alle Fragen.', 'error'); return;
            }

            const submitBtn = event.target.querySelector('button[type="submit"]');
            const submitText = document.getElementById('feedbackSubmitText');
            const submitSpinner = document.getElementById('feedbackSpinner');
            submitBtn.disabled = true; submitText.textContent = 'Wird gesendet...'; submitSpinner.style.display = 'block';

            const payload = {
                caseId: document.getElementById('caseSelect').value,
                score: lastEvaluation.totalScore,
                subs: lastEvaluation.subscores,
                helpful: feedbackData.helpful,
                likelihood: feedbackData.likelihood,
                comment: document.getElementById('feedbackComment').value.trim() || undefined,
                ts: new Date().toISOString(),
                client: { ua: navigator.userAgent, lang: navigator.language }
            };

            try {
                const res = await fetch(MAKE_FEEDBACK_WEBHOOK_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (!res.ok) throw new Error(`HTTP ${res.status}`);
                toast('Danke f√ºr dein Feedback!', 'success');
                closeFeedbackOverlay();
            } catch (error) {
                console.error('Feedback submission error:', error);
                toast('Feedback konnte nicht gesendet werden.', 'error');
                const pending = JSON.parse(localStorage.getItem('pendingFeedback') || '[]');
                pending.push(payload);
                localStorage.setItem('pendingFeedback', JSON.stringify(pending));
            } finally {
                submitBtn.disabled = false; submitText.textContent = 'Feedback senden'; submitSpinner.style.display = 'none';
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            toast('Willkommen bei WurstCaseScenario! W√§hle einen Fall aus und gib deine L√∂sung ein.', 'info');
            const pending = JSON.parse(localStorage.getItem('pendingFeedback') || '[]');
            if (pending.length > 0) {
                toast(`${pending.length} ausstehende Feedback(s) gefunden. Versuche erneut zu senden...`, 'info');
                retryPendingFeedback();
            }
        });

        async function retryPendingFeedback() {
            const pending = JSON.parse(localStorage.getItem('pendingFeedback') || '[]');
            if (pending.length === 0) return;
            const successful = [];
            for (let i = 0; i < pending.length; i++) {
                try {
                    const res = await fetch(MAKE_FEEDBACK_WEBHOOK_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(pending[i])
                    });
                    if (res.ok) successful.push(i);
                } catch (e) { console.error('Retry failed:', e); }
            }
            if (successful.length > 0) {
                const remaining = pending.filter((_, idx) => !successful.includes(idx));
                localStorage.setItem('pendingFeedback', JSON.stringify(remaining));
                toast(`${successful.length} Feedback(s) erfolgreich nachgesendet!`, 'success');
            }
        }
    </script>
</body>
</html>
